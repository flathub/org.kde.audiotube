From 32678936ccc6a2f70b2dfe8578317c588084ae0b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jonah=20Br=C3=BCchert?= <jbb@kaidan.im>
Date: Mon, 5 May 2025 13:10:12 +0200
Subject: [PATCH] Also find audio tracks with unknown acodec

---
 src/videoinfoextractor.cpp | 4 +++-
 src/ytmusic.cpp            | 3 ++-
 src/ytmusic.h              | 3 ++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/videoinfoextractor.cpp b/src/videoinfoextractor.cpp
index ced97d4d..c1c9d0b0 100644
--- a/src/videoinfoextractor.cpp
+++ b/src/videoinfoextractor.cpp
@@ -30,6 +30,7 @@ VideoInfoExtractor::VideoInfoExtractor(QObject *parent)
 QUrl VideoInfoExtractor::audioUrl() const
 {
     if (m_videoInfo.formats.empty()) {
+        qWarning() << "No formats found";
         return {};
     }
 
@@ -38,10 +39,11 @@ QUrl VideoInfoExtractor::audioUrl() const
     // filter audio only formats
     std::copy_if(m_videoInfo.formats.begin(), m_videoInfo.formats.end(), std::back_inserter(audioFormats),
         [](const video_info::Format &format) {
-        return format.acodec != "none" && format.vcodec == "none";
+        return (!format.acodec.has_value() || format.acodec != "none") && format.vcodec == "none";
     });
 
     if (audioFormats.empty()) {
+        qWarning() << "No audio track found";
         return {};
     }
 
diff --git a/src/ytmusic.cpp b/src/ytmusic.cpp
index f3ec7ca0..715a7cfb 100644
--- a/src/ytmusic.cpp
+++ b/src/ytmusic.cpp
@@ -156,10 +156,11 @@ album::Track extract_album_track(py::handle track) {
 
 video_info::Format extract_format(py::handle format) {
     return {
+        format["format_id"].cast<std::string>(),
         optional_key<float>(format, "quality"),
         format["url"].cast<std::string>(),
         format["vcodec"].cast<std::string>(),
-        optional_key<std::string>(format, "acodec").value_or("none") // returned inconsistently by yt-dlp
+        optional_key<std::string>(format, "acodec")
     };
 }
 
diff --git a/src/ytmusic.h b/src/ytmusic.h
index a932ecd4..a07a8c14 100644
--- a/src/ytmusic.h
+++ b/src/ytmusic.h
@@ -236,10 +236,11 @@ struct Playlist {
 
 namespace video_info {
 struct Format {
+    std::string format_id;
     std::optional<float> quality;
     std::string url;
     std::string vcodec;
-    std::string acodec;
+    std::optional<std::string> acodec;
 
     // More, but not interesting for us right now
 };
-- 
2.49.0

