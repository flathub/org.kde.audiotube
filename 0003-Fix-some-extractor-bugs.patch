From b4d184d7a3d94b26d32260cab8e4c90f4de35256 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mathis=20Br=C3=BCchert?= <mbb@kaidan.im>
Date: Fri, 31 Mar 2023 15:42:50 +0200
Subject: [PATCH 3/5] Fix some extractor bugs

---
 src/example/main.cpp | 2 +-
 src/ytmusic.cpp      | 8 ++++++--
 src/ytmusic.h        | 4 ++--
 3 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/src/example/main.cpp b/src/example/main.cpp
index 200c8f1..556de73 100644
--- a/src/example/main.cpp
+++ b/src/example/main.cpp
@@ -8,7 +8,7 @@
 
 int main() {
     const auto ytm = YTMusic();
-    const auto results = ytm.search("Leoniden");
+    const auto results = ytm.search("NAMASPAMUS");
 
     std::cout << "Found " << results.size() << " results." << std::endl;
 
diff --git a/src/ytmusic.cpp b/src/ytmusic.cpp
index 83a4048..01f9dc3 100644
--- a/src/ytmusic.cpp
+++ b/src/ytmusic.cpp
@@ -175,6 +175,10 @@ watch::Playlist::Track extract_watch_track(py::handle track) {
                 return std::nullopt;
             }
 
+            if (track["album"].is_none()) {
+                return std::nullopt;
+            }
+
             return extract_meta_album(track["album"]);
         }()
     };
@@ -293,7 +297,7 @@ std::optional<search::SearchResultItem> extract_search_result(py::handle result)
                 result["duration"].cast<std::string>(),
                 extract_py_list<meta::Thumbnail>(result["thumbnails"])
             },
-            extract_meta_album(result["album"]),
+            result["album"].is_none() ? std::optional<meta::Album> {} : extract_meta_album(result["album"]),
             result["isExplicit"].cast<bool>()
         };
     } else if (resultType == "album") {
@@ -392,7 +396,7 @@ album::Album YTMusic::get_album(const std::string &browseId) const
         album["trackCount"].cast<int>(),
         album["duration"].cast<std::string>(),
         album["audioPlaylistId"].cast<std::string>(),
-        album["year"].cast<std::string>(),
+        optional_key<std::string>(album, "year"),
         optional_key<std::string>(album, "description"),
         extract_py_list<meta::Thumbnail>(album["thumbnails"]),
         extract_py_list<album::Track>(album["tracks"]),
diff --git a/src/ytmusic.h b/src/ytmusic.h
index 13c66e5..2449fab 100644
--- a/src/ytmusic.h
+++ b/src/ytmusic.h
@@ -60,7 +60,7 @@ struct Playlist {
 };
 
 struct Song : public Media {
-    meta::Album album;
+    std::optional<meta::Album> album;
     bool is_explicit;
 };
 
@@ -167,7 +167,7 @@ namespace album {
         int track_count;
         std::string duration;
         std::string audio_playlist_id;
-        std::string year;
+        std::optional<std::string> year;
         std::optional<std::string> description;
         std::vector<meta::Thumbnail> thumbnails;
         std::vector<Track> tracks;
-- 
2.40.0

